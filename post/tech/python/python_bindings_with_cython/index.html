<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Create Python Bindings with Cython | Dennis&#39;s Grocery</title>
<meta name="keywords" content="python">
<meta name="description" content="The basic usages of Cython to create Python bindings">
<meta name="author" content="Dennis Xie">
<link rel="canonical" href="https://dennisxie.github.io/post/tech/python/python_bindings_with_cython/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.41f2d211c00e636a3c229c52ef2d4299a66891ae66771098993b13bca7972ae6.css" integrity="sha256-QfLSEcAOY2o8IpxS7y1CmaZoka5mdxCYmTsTvKeXKuY=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://dennisxie.github.io/images/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://dennisxie.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://dennisxie.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://dennisxie.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://dennisxie.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://dennisxie.github.io/post/tech/python/python_bindings_with_cython/">
<link rel="alternate" hreflang="zh" href="https://dennisxie.github.io/zh/post/tech/python/python_bindings_with_cython/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Create Python Bindings with Cython" />
<meta property="og:description" content="The basic usages of Cython to create Python bindings" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dennisxie.github.io/post/tech/python/python_bindings_with_cython/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-08T13:01:16&#43;08:00" />
<meta property="article:modified_time" content="2022-07-08T13:01:16&#43;08:00" /><meta property="og:site_name" content="Software Engineering" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Create Python Bindings with Cython"/>
<meta name="twitter:description" content="The basic usages of Cython to create Python bindings"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Create Python Bindings with Cython",
      "item": "https://dennisxie.github.io/post/tech/python/python_bindings_with_cython/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Create Python Bindings with Cython",
  "name": "Create Python Bindings with Cython",
  "description": "The basic usages of Cython to create Python bindings",
  "keywords": [
    "python"
  ],
  "articleBody": "Background Foreign function interface As we know, many operating systems only provide C API for system calls. This statement is not quite correct, but we assume this is right because we usually interact with operating systems via C API directly or indirectly. Have you ever thought about that why non-C language can interact with operating systems? Before we discuss this question, we need to know some knowledge of foreign function interface (FFI).\nThe term FFI refers to the language features for inter-language calls. Some of the non-C languages interact with operating systems via FFI. Many languages refer their FFI as ‘language bindings’, such as Python bindings. Some languages have their own terminology, such as Java’s JNI. With the ability of FFI, languages like Python can easily make system calls.\nPython bindings Python bindings allows you to call C API in pure Python or run Python scripts in C program.\nThere are two basic ways to implement the Python Bindings.\n The first way is using ctypes, a library provided by Python. The second way is using Python/C API, a library provided by CPython.  We can also choose to use some 3rd-party tools and libraries to make our life easier.\nCreate Python bindings via Cython Introduction Cython is a programming language that makes writing C extensions for the Python language as easy as Python itself and has a compiler that can compile Python and Cython to C. Cython can let you write Python-esque code that manually controls the GIL as Cython is compatible with Python and can be compiled to C. It is also very convinient to use C/C++ library in Cython. You can easily install Cython with the following command.\n1  pip install Cython   Basic usages of Cython The simplest example Any valid Python code is valid Cython code. This is the simplest example. Save the following code in the hello.pyx.\n1 2 3  # hello.pyx def say_hello_to(name): print(\"Hello %s\" % name)   Now, we can start to compile and build our extension. Save the following code in the setup.py.\n1 2 3 4 5 6 7  # setup.py from setuptools import setup from Cython.Build import cythonize setup( ext_modules = cythonize(\"hello.pyx\") )   Use the following command to build the Cython file. We can only use this module in the setup.py’s directory because we didn’t install this module.\n1  python setup.py build_ext --inplace   We can use this Cython module now! Just open the python interpreter and simply import it as if it was a regular Python module.\n1 2 3 4 5 6  Python 3.6.9 (default, Oct 8 2020, 12:12:24) [GCC 8.4.0] on linux Type \"help\", \"copyright\", \"credits\" or \"license\" for more information.  import hello  hello.sayHelloTo(\"Cython\") Hello Cython   Using static types In Cython, we can use static type to improve the performance in some cases. We can use cdef to declare static types. In addition, we can declare not only basic types of C but also struct, union, enum and their pointer types.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  def fibo(n): cdef int i = 2 cdef int a = 0 cdef int b = 1 cdef int c = 0 if n == 0: return a if n == 1: return b while i  n: c = a + b a = b b = c i += 1 return b   Function definitions There are three ways to define a function in Cython. We can use def, cdef, and cpdef to define a function. Functions with def statement are Python functions. They take Python objects as parameters and return Python objects. Functions with cdef statement are C functions. They take either Python objects or C values as parameters and can return either Python objects or C values. Functions with cpdef statement is a kind of hybrid function. They use the faster C calling convention when being called from other Cython code. Be careful, only functions with def or cpdef statement can be called from Python code. The following table shows their supported features.\n   statement Python objects param/return C variable param/return Called from python     def √ × √   cdef √ √ ×   cpdef √ √ √    The following code block shows the usage of these statements. When you need to call a C function from Python, you can use def or cpdef to write a wrapper function to call that C function.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  cdef double calcExponent(int a, int x): cdef int i = 0 cdef int flag = 0 cdef double ans = 1.0 if x == 0: return 1 if x  0: flag = 1 x = -x while i  x: ans = ans * a i += 1 if flag  0: ans = 1 / ans else: return ans def pyCalcExponent(int a, int x): return calcExponent(a, x) cpdef double cpCalcExponent(a, x): return calcExponent(a, x)   Call C standard library There are some pre-defined Cython modules for libc, libcpp and posix in Cython package. You can find the complete list of these modules here. The following code block shows the usage of pre-defined modules.\n1 2 3 4 5  # foolib.pyx from libc.math cimport cos def pyCos(x): return cos(x)   The libc math library is special in that it is not linked by default on some Unix-like systems. So we need to configure the build system to link the shared library m.\n1 2 3 4 5 6 7 8 9 10  # setup.py from setuptools import setup, Extension from Cython.Build import cythonize setup( ext_modules=cythonize([ Extension(\"foolib\", sources=[\"foolib.pyx\"], libraries=[\"m\"]) ]), zip_safe=False, )   The following command is the building command.\n1 2  # build \u0026 install command python setup.py build_ext --inplace   1 2 3 4 5 6  Python 3.6.9 (default, Oct 8 2020, 12:12:24) [GCC 8.4.0] on linux Type \"help\", \"copyright\", \"credits\" or \"license\" for more information.  import foolib as f  f.pyCos(3.14159265357589) -1.0   Build with C code In this example, we will implement two functions in C. The function called fibo calculates the Nth Fibonacci number. The other function called calcDistance calculates the distance of two points.\nThe C code The point and distance are defined in the header file foolib.h and the two functions are implemented in the source file foolib.c.\nHere is the header file and source file of the foolib.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  // foolib.h #ifndef __FOOLIB_H #define __FOOLIB_H typedef struct _Point { char name[50]; // Define a char array for name instead of char* to avoid memory management.  int x; int y; } Point; typedef struct _Distance { char start_name[50]; char end_name[50]; double distance; } Distance; extern int fibo(int n); extern Distance calcDistance(Point a, Point b); #endif   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  // foolib.c #include #include  #include \"foolib.h\" int fibo(int n) { int a = 0; int b = 1; if (n == 0) { return a; } if (n == 1) { return b; } int i; int c; for (i = 2; i  n; i++) { c = a + b; a = b; b = c; } return b; } Distance calcDistance(Point a, Point b) { Distance distance; strcpy(distance.start_name, a.name); strcpy(distance.end_name, b.name); int x = b.x - a.x; int y = b.y - a.y; double d2 = (double) (x * x + y * y); distance.distance = sqrt(d2); return distance; }   Then we compile the source code into the shared library with the following commands.\n1 2  gcc -c -Wall -Werror -fpic foolib.c gcc -shared -o libfoolib.so foolib.o -lm   In the first line, we compile the source code into the position-independent code (PIC)pic and we can get an object file named foolib.o. In the second line, we turn this object file into the shared library. Be careful, we need to name the shared library in the format of lib{name}.sosoname. So, in this example, we need to name the shared library libfoolib.so.\nThe Cython code Now, we start to write the Cython code. We first create a file called pfoolib.pxd. In the pxd file, we import the foolib.h header file and define the struct and function in Cython. Because Python code can’t call the functions or use the structures defined in the pxd file. So, we need to define wrapper functions to call these C functions and wrapper classes can be used by Python code. We define the wrapper functions and classes in the pfoolib.pyx. We can simply regard the pyd file as the header file of the pyx file. But we only declare the things implemented by C. The following code blocks are the pxd file and pyx file of the pfoolib.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  # pfoolib.pxd cdef extern from \"foolib.h\": # We can just define the fields that we need to use. # If we don't need to use any filed of this struct in some cases, # we can just put pass in the body of struct declaration. ctypedef struct Point: char name[50] int x int y ctypedef struct Distance: char start_name[50] char end_name[50] double distance int fibo(int n) Distance calcDistance(Point a, Point b)   In the pxd file, we can just declare the fields that we need to use. If we don’t need any field of this struct, we can just put pass in the body of struct declaration.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51  # pfoolib.pyx cimport pfoolib from libc.string cimport strcpy, strlen # The class name can't be same as Point defined in pfoolib.pxd, so we name it PyPoint cdef class PyPoint: cdef public bytes name cdef public int x cdef public int y def __init__(self, str name, int x, int y): # We need to encode the string into byte array. self.name = name.encode(\"utf-8\") self.x = x self.y = y cdef pfoolib.Point toCPoint(self): cdef pfoolib.Point p # Copy the byte array to the char array.  strcpy(p.name, self.name) p.x = self.x p.y = self.y return p cdef class PyDistance: cdef public str start_name cdef public str end_name cdef public double distance def __init__(self, char* start_name, char* end_name, float distance): self.start_name = start_name[:strlen(start_name)].decode(\"utf-8\") self.end_name = end_name[:strlen(end_name)].decode(\"utf-8\") self.distance = distance cdef pfoolib.Distance toCDistance(self): cdef pfoolib.Distance d d.start_name = self.start_name d.end_name = self.end_name d.distance = self.distance def pyFibo(n): return fibo(n) cpdef PyDistance pyCalcDistance(PyPoint a, PyPoint b): # Transfer the python class to c struct. cdef pfoolib.Point cpa = a.toCPoint() cdef pfoolib.Point cpb = b.toCPoint() cdef pfoolib.Distance dis = pfoolib.calcDistance(cpa, cpb) d = PyDistance(dis.start_name, dis.end_name, dis.distance) return d   If the pyx file, there are a few things we need to be careful with.\n The class name needs to be different from the name defined in the pxd file. In the official document, they use the same name. But when I use the same name, I got a redeclaration error and I don’t know why. Because we use the char array for name, we can only use strcpy to copy the string to the name. If you just use assignment, you will get a runtime index error. If you define the name as char*, then you can use assignment directly. The bytes in Python3 is correspond to the string in C. So, we need to use encode and decode to transform the string. Cython compiler will generate a same name C file for every pyx file. If your C files and pyx files are in the same directory, you’d better give them different names.  The following file is the setup file of our module. We can build and install our module with this file. Pay attention to the libraries field of the Extension class, this field tells Cython what library we need. Here we provide the foolib, then the C compiler will find the libfoolib.so in the link stage.\n1 2 3 4 5 6 7 8 9 10 11  # setup.py from setuptools import setup, Extension from Cython.Build import cythonize setup( name = \"pfoolib\", ext_modules=cythonize([ Extension(\"pfoolib\", [\"pfoolib.pyx\"], libraries=[\"foolib\"]) ]), zip_safe=False )   Now, works are almost done. We just type the following command to build the Cython module.\n1  CFLAGS=\"-I/path/to/headers\" LDFLAGS=\"-L/path/to/library\" python3 setup.py build_ext --inplace   We can use the foolib shared library in Python now. In the build directory (or you use it anywhere if you install it), type python and try it in the terminal.\n1 2 3 4 5 6 7 8 9 10 11 12 13  Python 3.6.9 (default, Oct 8 2020, 12:12:24) [GCC 8.4.0] on linux Type \"help\", \"copyright\", \"credits\" or \"license\" for more information.  import pfoolib  a = pfoolib.PyPoint(\"aaa\", 1, 3)  b = pfoolib.PyPoint(\"ccc\", 2, 3)  c = pfoolib.pyCalcDistance(a, b)  c.start_name 'aaa'  c.end_name 'bbb'  c.distance 1.0   The makefile We can write a simple Makefile to avoid typing the long shell command. The following code block shows the content of the makefile.\n1 2 3 4 5 6 7 8 9 10 11 12 13  # Makefile pwd:=$(shell pwd) build: sharelib CFLAGS=\"-I$(pwd)\" LDFLAGS=\"-L$(pwd)\" python3 setup.py build_ext --inplace sharelib: gcc -c -Wall -Werror -fpic foolib.c gcc -shared -o libfoolib.so foolib.o -lm clean: rm -f foolib.o libfoolib.so pfoolib.*.so rm -rf build   Now, we can simply use the make command to compile, build and clean.\n1 2 3  make sharelib # compile the share library with out building Cython module make build # compile the share library and build Cython module make clean # remove the compiling and building results.   Python callback functions Sometimes, we need to provide callbacks to our library. This section will give a simple example to show how to provide callback functions to our C library. In this example, we implement a function to filter an array’s elements. The function will take an array and predicate function for input.\nThe C code The following code blocks show the header file and source file.\n1 2 3 4 5 6 7  // foolib.h #ifndef __FOOLIB_H #define __FOOLIB_H typedef int (*predicate)(int, void*); extern int filter(int [], int, predicate, void*); #endif   In the header file, we declare the predicate type for callback functions. The predicate has a void* parameter to get the context. The context will contain the real Python predicate function. If we don’t provide a void* parameter, we can only use a callback function without any context.\n1 2 3 4 5 6 7 8 9 10 11 12  // foolib.c int filter(int arr[], int length, predicate check, void* p) { int i = 0; int j = 0; for (i = 0; i  length; i++) { if (check(arr[i], p)  0) { arr[j] = arr[i]; j++; } } return j; }   The Cython code The following code blocks show the pxd file and pyx file.\n1 2 3  # pfoolib.pxd cdef extern from \"foolib.h\": int filter(int [], int, predicate, void*)   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  # pfoolib.pyx cimport pfoolib from libc.stdlib cimport malloc, free cdef int cCallBack(int a, void *p): try: func = objectp if func(a): return 1 else: return 0 except: return -1 def pyFilter(list arr, judge): cdef int* cArr = int* malloc(len(arr) * sizeof(int)) if not cArr: raise MemoryError() try: for i in range(len(arr)): cArr[i] = arr[i] newLength = filter(cArr, len(arr), cCallBack, void* judge) for i in range(newLength): arr[i] = cArr[i] return arr[:newLength] finally: free(cArr)   The cCallBack is a callback function provided to the filter function. cCallBack will get the Python callback function from void* parameter and call it to check whether to keep an element in the array. The filter function takes an integer array. The array is equivalent to the pointer in C. Cython can’t automatically transfer a Python list to an array if the array doesn’t have a fixed length. So, we need to malloc an array in the heap, copy the elements to this array, and finally free this array after use.\nThe setup script and build command are the same as the previous example. Now, try to use this filter function.\n1 2 3 4 5 6  Python 3.6.9 (default, Oct 8 2020, 12:12:24) [GCC 8.4.0] on linux Type \"help\", \"copyright\", \"credits\" or \"license\" for more information.  import pfoolib as p  p.pyFilter([1, 3, -3, 0, 9, -8, 2], lambda x: x  0) [1, 3, 9, 2]   Conclusion The examples in this blog only show the basic usages of Cython. But these examples can cover many situations that integrate Python code with C code. In the future, I’ll introduce more advanced usages of Cython.\nExplanation  What is position independent code (PIC)? PIC is code that works no matter where in memory it is placed. Because several different programs can all use one instance of your shared library, the library cannot store things at fixed addresses, since the location of that library in memory will vary from program to program.2 Every shared library in Unix-like system has a ‘so-name’, the so-name need to have a lib prefix and .so suffix by default. So, the so-name of foo library is libfoo.so. When you pass a ‘-lfoo’ parameter to GCC, the compiler will look up the libfoo.so in the link stage. But some basic C libraries don’t have this constraint.  Reference  Cython official document Shared libraries with GCC on Linux Makefile tutorial  ",
  "wordCount" : "2978",
  "inLanguage": "en",
  "datePublished": "2022-07-08T13:01:16+08:00",
  "dateModified": "2022-07-08T13:01:16+08:00",
  "author":{
    "@type": "Person",
    "name": "Dennis Xie"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://dennisxie.github.io/post/tech/python/python_bindings_with_cython/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Dennis's Grocery",
    "logo": {
      "@type": "ImageObject",
      "url": "https://dennisxie.github.io/images/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://dennisxie.github.io/" accesskey="h" title="Dennis&#39;s Grocery (Alt + H)">Dennis&#39;s Grocery</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://dennisxie.github.io/zh/" title="Chinese"
                            aria-label="Chinese">Zh</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://dennisxie.github.io/categories/tech/" title="Tech">
                    <span>Tech</span>
                </a>
            </li>
            <li>
                <a href="https://dennisxie.github.io/categories/cook/" title="Cook">
                    <span>Cook</span>
                </a>
            </li>
            <li>
                <a href="https://dennisxie.github.io/categories/other/" title="Other">
                    <span>Other</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://dennisxie.github.io/">Home</a></div>
    <h1 class="post-title">
      Create Python Bindings with Cython
    </h1>
    <div class="post-description">
      The basic usages of Cython to create Python bindings
    </div>
    <div class="post-meta"><span title='2022-07-08 13:01:16 +0800 CST'>July 8, 2022</span>&nbsp;·&nbsp;Dennis Xie&nbsp;|&nbsp;Translations:
<ul class="i18n_list">
    <li>
        <a href="https://dennisxie.github.io/zh/post/tech/python/python_bindings_with_cython/">Zh</a>
    </li>
</ul>

</div>
  </header> 
  <div class="post-content"><h1 id="background">Background<a hidden class="anchor" aria-hidden="true" href="#background">#</a></h1>
<h2 id="foreign-function-interface">Foreign function interface<a hidden class="anchor" aria-hidden="true" href="#foreign-function-interface">#</a></h2>
<p>As we know, many operating systems only provide C API for system calls.  This statement is not quite correct, but we assume this is right because we usually interact with operating systems via C API directly or indirectly. Have you ever thought about that why non-C language can interact with operating systems? Before we discuss this question, we need to know some knowledge of foreign function interface (FFI).</p>
<p>The term FFI refers to the language features for inter-language calls. Some of the non-C languages interact with operating systems via FFI. Many languages refer their FFI as ‘language bindings’, such as Python bindings. Some languages have their own terminology, such as Java’s JNI. With the ability of FFI, languages like Python can easily make system calls.</p>
<h2 id="python-bindings">Python bindings<a hidden class="anchor" aria-hidden="true" href="#python-bindings">#</a></h2>
<p>Python bindings allows you to call C API in pure Python or run Python scripts in C program.</p>
<p>There are two basic ways to implement the Python Bindings.</p>
<ul>
<li>The first way is using ctypes, a library provided by Python.</li>
<li>The second way is using Python/C API, a library provided by CPython.</li>
</ul>
<p>We can also choose to use some 3rd-party tools and libraries to make our life easier.</p>
<h1 id="create-python-bindings-via-cython">Create Python bindings via Cython<a hidden class="anchor" aria-hidden="true" href="#create-python-bindings-via-cython">#</a></h1>
<h2 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h2>
<p>Cython is a programming language that makes writing C extensions for the Python language as easy as Python itself and has a compiler that can compile Python and Cython to C. Cython can let you write Python-esque code that manually controls the GIL as Cython is compatible with Python and can be compiled to C. It is also very convinient to use C/C++ library in Cython. You can easily install Cython with the following command.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pip install Cython
</code></pre></td></tr></table>
</div>
</div><h2 id="basic-usages-of-cython">Basic usages of Cython<a hidden class="anchor" aria-hidden="true" href="#basic-usages-of-cython">#</a></h2>
<h3 id="the-simplest-example">The simplest example<a hidden class="anchor" aria-hidden="true" href="#the-simplest-example">#</a></h3>
<p>Any valid Python code is valid Cython code. This is the simplest example. Save the following code in the <em>hello.pyx</em>.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># hello.pyx</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">say_hello_to</span>(name):
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Hello </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> name)
</code></pre></td></tr></table>
</div>
</div><p>Now, we can start to compile and build our extension. Save the following code in the <em>setup.py</em>.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># setup.py</span>
<span style="color:#f92672">from</span> setuptools <span style="color:#f92672">import</span> setup
<span style="color:#f92672">from</span> Cython.Build <span style="color:#f92672">import</span> cythonize

setup(
    ext_modules <span style="color:#f92672">=</span> cythonize(<span style="color:#e6db74">&#34;hello.pyx&#34;</span>)
)
</code></pre></td></tr></table>
</div>
</div><p>Use the following command to build the Cython file. We can only use this module in the <em>setup.py</em>’s directory because we didn’t install this module.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">python setup.py build_ext --inplace
</code></pre></td></tr></table>
</div>
</div><p>We can use this Cython module now! Just open the python interpreter and simply import it as if it was a regular Python module.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">Python <span style="color:#ae81ff">3.6</span><span style="color:#f92672">.</span><span style="color:#ae81ff">9</span> (default, Oct  <span style="color:#ae81ff">8</span> <span style="color:#ae81ff">2020</span>, <span style="color:#ae81ff">12</span>:<span style="color:#ae81ff">12</span>:<span style="color:#ae81ff">24</span>)
[GCC <span style="color:#ae81ff">8.4</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span>] on linux
Type <span style="color:#e6db74">&#34;help&#34;</span>, <span style="color:#e6db74">&#34;copyright&#34;</span>, <span style="color:#e6db74">&#34;credits&#34;</span> <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;license&#34;</span> <span style="color:#66d9ef">for</span> more information<span style="color:#f92672">.</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">import</span> hello
<span style="color:#f92672">&gt;&gt;&gt;</span> hello<span style="color:#f92672">.</span>sayHelloTo(<span style="color:#e6db74">&#34;Cython&#34;</span>)
Hello Cython
</code></pre></td></tr></table>
</div>
</div><h3 id="using-static-types">Using static types<a hidden class="anchor" aria-hidden="true" href="#using-static-types">#</a></h3>
<p>In Cython, we can use static type to improve the performance in some cases. We can use cdef to declare static types. In addition, we can declare not only basic types of C but also struct, union, enum and their pointer types.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fibo</span>(n):
    cdef int i <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
    cdef int a <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    cdef int b <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
    cdef int c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>

    <span style="color:#66d9ef">if</span> n <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
        <span style="color:#66d9ef">return</span> a
    <span style="color:#66d9ef">if</span> n <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
        <span style="color:#66d9ef">return</span> b

    <span style="color:#66d9ef">while</span> i <span style="color:#f92672">&lt;=</span> n:
        c <span style="color:#f92672">=</span> a <span style="color:#f92672">+</span> b
        a <span style="color:#f92672">=</span> b
        b <span style="color:#f92672">=</span> c
        i <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">return</span> b
</code></pre></td></tr></table>
</div>
</div><h3 id="function-definitions">Function definitions<a hidden class="anchor" aria-hidden="true" href="#function-definitions">#</a></h3>
<p>There are three ways to define a function in Cython. We can use def, cdef, and cpdef to define a function. Functions with def statement are Python functions. They take Python objects as parameters and return Python objects. Functions with cdef statement are C functions. They take either Python objects or C values as parameters and can return either Python objects or C values. Functions with cpdef statement is a kind of hybrid function. They use the faster C calling convention when being called from other Cython code. Be careful, only functions with def or cpdef statement can be called from Python code. The following table shows their supported features.</p>
<table>
<thead>
<tr>
<th align="center">statement</th>
<th align="center">Python objects param/return</th>
<th align="center">C variable param/return</th>
<th align="center">Called from python</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">def</td>
<td align="center">√</td>
<td align="center">×</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">cdef</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">×</td>
</tr>
<tr>
<td align="center">cpdef</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
</tr>
</tbody>
</table>
<p>The following code block shows the usage of these statements. When you need to call a C function from Python, you can use def or cpdef to write a wrapper function to call that C function.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">cdef double calcExponent(int a, int x):
    cdef int i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> 
    cdef int flag <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    cdef double ans <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span>

    <span style="color:#66d9ef">if</span> x <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
    
    <span style="color:#66d9ef">if</span> x <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>:
        flag <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
        x <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>x

    <span style="color:#66d9ef">while</span> i <span style="color:#f92672">&lt;</span> x:
        ans <span style="color:#f92672">=</span> ans <span style="color:#f92672">*</span> a
        i <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
    
    <span style="color:#66d9ef">if</span> flag <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
        ans <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">/</span> ans
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">return</span> ans

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">pyCalcExponent</span>(int a, int x):
    <span style="color:#66d9ef">return</span> calcExponent(a, x)

cpdef double cpCalcExponent(a, x):
    <span style="color:#66d9ef">return</span> calcExponent(a, x)
</code></pre></td></tr></table>
</div>
</div><h2 id="call-c-standard-library">Call C standard library<a hidden class="anchor" aria-hidden="true" href="#call-c-standard-library">#</a></h2>
<p>There are some pre-defined Cython modules for libc, libcpp and posix in Cython package. You can find the complete list of these modules <a href="https://github.com/cython/cython/tree/master/Cython/Includes">here</a>. The following code block shows the usage of pre-defined modules.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># foolib.pyx</span>
<span style="color:#f92672">from</span> libc.math cimport cos

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">pyCos</span>(x):
    <span style="color:#66d9ef">return</span> cos(x)
</code></pre></td></tr></table>
</div>
</div><p>The libc math library is special in that it is not linked by default on some Unix-like systems. So we need to configure the build system to link the shared library m.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># setup.py</span>
<span style="color:#f92672">from</span> setuptools <span style="color:#f92672">import</span> setup, Extension
<span style="color:#f92672">from</span> Cython.Build <span style="color:#f92672">import</span> cythonize

setup(
    ext_modules<span style="color:#f92672">=</span>cythonize([
        Extension(<span style="color:#e6db74">&#34;foolib&#34;</span>, sources<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;foolib.pyx&#34;</span>], libraries<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;m&#34;</span>])
        ]),
    zip_safe<span style="color:#f92672">=</span>False,
)
</code></pre></td></tr></table>
</div>
</div><p>The following command is the building command.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># build &amp; install command</span>
python setup.py build_ext --inplace
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">Python <span style="color:#ae81ff">3.6</span><span style="color:#f92672">.</span><span style="color:#ae81ff">9</span> (default, Oct  <span style="color:#ae81ff">8</span> <span style="color:#ae81ff">2020</span>, <span style="color:#ae81ff">12</span>:<span style="color:#ae81ff">12</span>:<span style="color:#ae81ff">24</span>)
[GCC <span style="color:#ae81ff">8.4</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span>] on linux
Type <span style="color:#e6db74">&#34;help&#34;</span>, <span style="color:#e6db74">&#34;copyright&#34;</span>, <span style="color:#e6db74">&#34;credits&#34;</span> <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;license&#34;</span> <span style="color:#66d9ef">for</span> more information<span style="color:#f92672">.</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">import</span> foolib <span style="color:#f92672">as</span> f
<span style="color:#f92672">&gt;&gt;&gt;</span> f<span style="color:#f92672">.</span>pyCos(<span style="color:#ae81ff">3.14159265357589</span>)
<span style="color:#f92672">-</span><span style="color:#ae81ff">1.0</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="build-with-c-code">Build with C code<a hidden class="anchor" aria-hidden="true" href="#build-with-c-code">#</a></h2>
<p>In this example, we will implement two functions in C. The function called <em>fibo</em> calculates the Nth Fibonacci number. The other function called <em>calcDistance</em> calculates the distance of two points.</p>
<h3 id="the-c-code">The C code<a hidden class="anchor" aria-hidden="true" href="#the-c-code">#</a></h3>
<p>The point and distance are defined in the header file <em>foolib.h</em> and the two functions are implemented in the source file <em>foolib.c</em>.</p>
<p>Here is the header file and source file of the foolib.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// foolib.h
</span><span style="color:#75715e"></span><span style="color:#75715e">#ifndef __FOOLIB_H
</span><span style="color:#75715e">#define __FOOLIB_H
</span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> _Point {
	<span style="color:#66d9ef">char</span> name[<span style="color:#ae81ff">50</span>];    <span style="color:#75715e">// Define a char array for name instead of char* to avoid memory management.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> x;
    <span style="color:#66d9ef">int</span> y;
} Point;

<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> _Distance {
    <span style="color:#66d9ef">char</span> start_name[<span style="color:#ae81ff">50</span>];
    <span style="color:#66d9ef">char</span> end_name[<span style="color:#ae81ff">50</span>];
    <span style="color:#66d9ef">double</span> distance;
} Distance;

<span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">fibo</span>(<span style="color:#66d9ef">int</span> n);

<span style="color:#66d9ef">extern</span> Distance <span style="color:#a6e22e">calcDistance</span>(Point a, Point b);
<span style="color:#75715e">#endif
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// foolib.c
</span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;math.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;foolib.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">fibo</span>(<span style="color:#66d9ef">int</span> n) {
    <span style="color:#66d9ef">int</span> a <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> b <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">if</span> (n <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
        <span style="color:#66d9ef">return</span> a;
    }
    <span style="color:#66d9ef">if</span> (n <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
        <span style="color:#66d9ef">return</span> b;
    }
    <span style="color:#66d9ef">int</span> i;
    <span style="color:#66d9ef">int</span> c;
    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>; i <span style="color:#f92672">&lt;=</span> n; i<span style="color:#f92672">++</span>) {
        c <span style="color:#f92672">=</span> a <span style="color:#f92672">+</span> b;
        a <span style="color:#f92672">=</span> b;
        b <span style="color:#f92672">=</span> c;
    }
    <span style="color:#66d9ef">return</span> b;
}

Distance <span style="color:#a6e22e">calcDistance</span>(Point a, Point b) {
    Distance distance;
    strcpy(distance.start_name, a.name);
    strcpy(distance.end_name, b.name);
    <span style="color:#66d9ef">int</span> x <span style="color:#f92672">=</span> b.x <span style="color:#f92672">-</span> a.x;
    <span style="color:#66d9ef">int</span> y <span style="color:#f92672">=</span> b.y <span style="color:#f92672">-</span> a.y;
    <span style="color:#66d9ef">double</span> d2 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">double</span>) (x <span style="color:#f92672">*</span> x <span style="color:#f92672">+</span> y <span style="color:#f92672">*</span> y);
    distance.distance <span style="color:#f92672">=</span> sqrt(d2);
    <span style="color:#66d9ef">return</span> distance;
}
</code></pre></td></tr></table>
</div>
</div><p>Then we compile the source code into the shared library with the following commands.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">	gcc -c -Wall -Werror -fpic foolib.c
	gcc -shared -o libfoolib.so foolib.o -lm
</code></pre></td></tr></table>
</div>
</div><p>In the first line, we compile the source code into the position-independent code (PIC)<sup><a href="#explanation">pic</a></sup> and we can get an object file named <em>foolib.o</em>. In the second line, we turn this object file into the shared library. Be careful, we need to name the shared library in the format of <em>lib{name}.so</em><sup><a href="#explanation">soname</a></sup>. So, in this example, we need to name the shared library <em>libfoolib.so</em>.</p>
<h3 id="the-cython-code">The Cython code<a hidden class="anchor" aria-hidden="true" href="#the-cython-code">#</a></h3>
<p>Now, we start to write the Cython code. We first create a file called <em>pfoolib.pxd</em>. In the pxd file, we import the <em>foolib.h</em> header file and define the struct and function in Cython. Because Python code can’t call the functions or use the structures defined in the pxd file. So, we need to define wrapper functions to call these C functions and wrapper classes can be used by Python code. We define the wrapper functions and classes in the <em>pfoolib.pyx</em>. We can simply regard the pyd file as the header file of the pyx file. But we only declare the things implemented by C. The following code blocks are the pxd file and pyx file of the pfoolib.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># pfoolib.pxd</span>
cdef extern <span style="color:#f92672">from</span> <span style="color:#e6db74">&#34;foolib.h&#34;</span>:
    <span style="color:#75715e"># We can just define the fields that we need to use.</span>
    <span style="color:#75715e"># If we don&#39;t need to use any filed of this struct in some cases,</span>
    <span style="color:#75715e"># we can just put pass in the body of struct declaration.</span>
    ctypedef struct Point:
        char name[<span style="color:#ae81ff">50</span>]
        int x
        int y
    
    ctypedef struct Distance:
        char start_name[<span style="color:#ae81ff">50</span>]
        char end_name[<span style="color:#ae81ff">50</span>]
        double distance
    
    int fibo(int n)

    Distance calcDistance(Point a, Point b)
</code></pre></td></tr></table>
</div>
</div><p>In the pxd file, we can just declare the fields that we need to use. If we don’t need any field of this struct, we can just put pass in the body of struct declaration.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># pfoolib.pyx</span>
cimport pfoolib

<span style="color:#f92672">from</span> libc.string cimport strcpy, strlen

<span style="color:#75715e"># The class name can&#39;t be same as Point defined in pfoolib.pxd, so we name it PyPoint</span>
cdef <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PyPoint</span>:
    cdef public bytes name
    cdef public int x
    cdef public int y

    <span style="color:#66d9ef">def</span> __init__(self, str name, int x, int y):
		<span style="color:#75715e"># We need to encode the string into byte array.</span>
        self<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;utf-8&#34;</span>)
        self<span style="color:#f92672">.</span>x <span style="color:#f92672">=</span> x
        self<span style="color:#f92672">.</span>y <span style="color:#f92672">=</span> y
    
    cdef pfoolib<span style="color:#f92672">.</span>Point toCPoint(self):
        cdef pfoolib<span style="color:#f92672">.</span>Point p
        <span style="color:#75715e"># Copy the byte array to the char array. </span>
        strcpy(p<span style="color:#f92672">.</span>name, self<span style="color:#f92672">.</span>name)
        p<span style="color:#f92672">.</span>x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>x
        p<span style="color:#f92672">.</span>y <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>y
        <span style="color:#66d9ef">return</span> p

cdef <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PyDistance</span>:
    cdef public str start_name
    cdef public str end_name
    cdef public double distance

    <span style="color:#66d9ef">def</span> __init__(self, char<span style="color:#f92672">*</span> start_name, char<span style="color:#f92672">*</span> end_name, float distance):
        self<span style="color:#f92672">.</span>start_name <span style="color:#f92672">=</span> start_name[:strlen(start_name)]<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#34;utf-8&#34;</span>)
        self<span style="color:#f92672">.</span>end_name <span style="color:#f92672">=</span> end_name[:strlen(end_name)]<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#34;utf-8&#34;</span>)
        self<span style="color:#f92672">.</span>distance <span style="color:#f92672">=</span> distance
    
    cdef pfoolib<span style="color:#f92672">.</span>Distance toCDistance(self):
        cdef pfoolib<span style="color:#f92672">.</span>Distance d
        d<span style="color:#f92672">.</span>start_name <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>start_name
        d<span style="color:#f92672">.</span>end_name <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>end_name
        d<span style="color:#f92672">.</span>distance <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>distance

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">pyFibo</span>(n):
		<span style="color:#66d9ef">return</span> fibo(n)

cpdef PyDistance pyCalcDistance(PyPoint a, PyPoint b):
	<span style="color:#75715e"># Transfer the python class to c struct.</span>
    cdef pfoolib<span style="color:#f92672">.</span>Point cpa <span style="color:#f92672">=</span> a<span style="color:#f92672">.</span>toCPoint()
    cdef pfoolib<span style="color:#f92672">.</span>Point cpb <span style="color:#f92672">=</span> b<span style="color:#f92672">.</span>toCPoint()
    cdef pfoolib<span style="color:#f92672">.</span>Distance dis <span style="color:#f92672">=</span> pfoolib<span style="color:#f92672">.</span>calcDistance(cpa, cpb)
    d <span style="color:#f92672">=</span> PyDistance(dis<span style="color:#f92672">.</span>start_name, dis<span style="color:#f92672">.</span>end_name, dis<span style="color:#f92672">.</span>distance)
    <span style="color:#66d9ef">return</span> d
</code></pre></td></tr></table>
</div>
</div><p>If the pyx file, there are a few things we need to be careful with.</p>
<ul>
<li>The class name needs to be different from the name defined in the pxd file. In the official document, they use the same name. But when I use the same name, I got a redeclaration error and I don’t know why.</li>
<li>Because we use the char array for name, we can only use strcpy to copy the string to the name. If you just use assignment, you will get a runtime index error. If you define the name as char*, then you can use assignment directly.</li>
<li>The bytes in Python3 is correspond to the string in C. So, we need to use encode and decode to transform the string.</li>
<li>Cython compiler will generate a same name C file for every pyx file. If your C files and pyx files are in the same directory, you’d better give them different names.</li>
</ul>
<p>The following file is the setup file of our module. We can build and install our module with this file. Pay attention to the <em>libraries</em> field of the Extension class, this field tells Cython what library we need. Here we provide the <em>foolib</em>, then the C compiler will find the <em>libfoolib.so</em> in the link stage.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># setup.py</span>
<span style="color:#f92672">from</span> setuptools <span style="color:#f92672">import</span> setup, Extension
<span style="color:#f92672">from</span> Cython.Build <span style="color:#f92672">import</span> cythonize

setup(
    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;pfoolib&#34;</span>,
    ext_modules<span style="color:#f92672">=</span>cythonize([
        Extension(<span style="color:#e6db74">&#34;pfoolib&#34;</span>, [<span style="color:#e6db74">&#34;pfoolib.pyx&#34;</span>], libraries<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;foolib&#34;</span>])
    ]),
    zip_safe<span style="color:#f92672">=</span>False
)
</code></pre></td></tr></table>
</div>
</div><p>Now, works are almost done. We just type the following command to build the Cython module.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">CFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-I/path/to/headers&#34;</span> LDFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-L/path/to/library&#34;</span> python3 setup.py build_ext --inplace
</code></pre></td></tr></table>
</div>
</div><p>We can use the foolib shared library in Python now. In the build directory (or you use it anywhere if you install it), type python and try it in the terminal.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">Python <span style="color:#ae81ff">3.6</span><span style="color:#f92672">.</span><span style="color:#ae81ff">9</span> (default, Oct  <span style="color:#ae81ff">8</span> <span style="color:#ae81ff">2020</span>, <span style="color:#ae81ff">12</span>:<span style="color:#ae81ff">12</span>:<span style="color:#ae81ff">24</span>)
[GCC <span style="color:#ae81ff">8.4</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span>] on linux
Type <span style="color:#e6db74">&#34;help&#34;</span>, <span style="color:#e6db74">&#34;copyright&#34;</span>, <span style="color:#e6db74">&#34;credits&#34;</span> <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;license&#34;</span> <span style="color:#66d9ef">for</span> more information<span style="color:#f92672">.</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">import</span> pfoolib
<span style="color:#f92672">&gt;&gt;&gt;</span> a <span style="color:#f92672">=</span> pfoolib<span style="color:#f92672">.</span>PyPoint(<span style="color:#e6db74">&#34;aaa&#34;</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>)
<span style="color:#f92672">&gt;&gt;&gt;</span> b <span style="color:#f92672">=</span> pfoolib<span style="color:#f92672">.</span>PyPoint(<span style="color:#e6db74">&#34;ccc&#34;</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>)
<span style="color:#f92672">&gt;&gt;&gt;</span> c <span style="color:#f92672">=</span> pfoolib<span style="color:#f92672">.</span>pyCalcDistance(a, b)
<span style="color:#f92672">&gt;&gt;&gt;</span> c<span style="color:#f92672">.</span>start_name
<span style="color:#e6db74">&#39;aaa&#39;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> c<span style="color:#f92672">.</span>end_name
<span style="color:#e6db74">&#39;bbb&#39;</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> c<span style="color:#f92672">.</span>distance
<span style="color:#ae81ff">1.0</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="the-makefile">The makefile<a hidden class="anchor" aria-hidden="true" href="#the-makefile">#</a></h3>
<p>We can write a simple Makefile to avoid typing the long shell command. The following code block shows the content of the makefile.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-makefile" data-lang="makefile"><span style="color:#75715e"># Makefile
</span><span style="color:#75715e"></span>pwd<span style="color:#f92672">:=</span><span style="color:#66d9ef">$(</span>shell pwd<span style="color:#66d9ef">)</span>

<span style="color:#a6e22e">build</span><span style="color:#f92672">:</span> sharelib
	CFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-I</span><span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> LDFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-L</span><span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> python3 setup.py build_ext --inplace

<span style="color:#a6e22e">sharelib</span><span style="color:#f92672">:</span>
	gcc -c -Wall -Werror -fpic foolib.c
	gcc -shared -o libfoolib.so foolib.o -lm

<span style="color:#a6e22e">clean</span><span style="color:#f92672">:</span>
	rm -f foolib.o libfoolib.so pfoolib.*.so
	rm -rf build
</code></pre></td></tr></table>
</div>
</div><p>Now, we can simply use the make command to compile, build and clean.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">make sharelib    <span style="color:#75715e"># compile the share library with out building Cython module</span>
make build       <span style="color:#75715e"># compile the share library and build Cython module</span>
make clean       <span style="color:#75715e"># remove the compiling and building results.</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="python-callback-functions">Python callback functions<a hidden class="anchor" aria-hidden="true" href="#python-callback-functions">#</a></h2>
<p>Sometimes, we need to provide callbacks to our library. This section will give a simple example to show how to provide callback functions to our C library. In this example, we implement a function to filter an array’s elements. The function will take an array and predicate function for input.</p>
<h3 id="the-c-code-1">The C code<a hidden class="anchor" aria-hidden="true" href="#the-c-code-1">#</a></h3>
<p>The following code blocks show the header file and source file.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// foolib.h
</span><span style="color:#75715e"></span><span style="color:#75715e">#ifndef __FOOLIB_H
</span><span style="color:#75715e">#define __FOOLIB_H
</span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">int</span> (<span style="color:#f92672">*</span>predicate)(<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>);

<span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">filter</span>(<span style="color:#66d9ef">int</span> [], <span style="color:#66d9ef">int</span>, predicate, <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>);
<span style="color:#75715e">#endif
</span></code></pre></td></tr></table>
</div>
</div><p>In the header file, we declare the predicate type for callback functions. The predicate has a void* parameter to get the context. The context will contain the real Python predicate function. If we don’t provide a void* parameter, we can only use a callback function without any context.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// foolib.c
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">filter</span>(<span style="color:#66d9ef">int</span> arr[], <span style="color:#66d9ef">int</span> length, predicate check, <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> p) {
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> length; i<span style="color:#f92672">++</span>) {
        <span style="color:#66d9ef">if</span> (check(arr[i], p) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
            arr[j] <span style="color:#f92672">=</span> arr[i];
            j<span style="color:#f92672">++</span>;
        }
    }
    <span style="color:#66d9ef">return</span> j;
}
</code></pre></td></tr></table>
</div>
</div><h3 id="the-cython-code-1">The Cython code<a hidden class="anchor" aria-hidden="true" href="#the-cython-code-1">#</a></h3>
<p>The following code blocks show the pxd file and pyx file.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># pfoolib.pxd</span>
cdef extern <span style="color:#f92672">from</span> <span style="color:#e6db74">&#34;foolib.h&#34;</span>:
	int filter(int [], int, predicate, void<span style="color:#f92672">*</span>)
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># pfoolib.pyx</span>
cimport pfoolib
<span style="color:#f92672">from</span> libc.stdlib cimport malloc, free

cdef int cCallBack(int a, void <span style="color:#f92672">*</span>p):
    <span style="color:#66d9ef">try</span>:
        func <span style="color:#f92672">=</span> <span style="color:#f92672">&lt;</span>object<span style="color:#f92672">&gt;</span>p
        <span style="color:#66d9ef">if</span> func(a):
            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">except</span>:
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">pyFilter</span>(list arr, judge):
    cdef int<span style="color:#f92672">*</span> cArr <span style="color:#f92672">=</span> <span style="color:#f92672">&lt;</span>int<span style="color:#f92672">*&gt;</span> malloc(len(arr) <span style="color:#f92672">*</span> sizeof(int))
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> cArr:
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">MemoryError</span>()

    <span style="color:#66d9ef">try</span>:
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(arr)):
            cArr[i] <span style="color:#f92672">=</span> arr[i]

        newLength <span style="color:#f92672">=</span> filter(cArr, len(arr), cCallBack, <span style="color:#f92672">&lt;</span>void<span style="color:#f92672">*&gt;</span> judge)

        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(newLength):
            arr[i] <span style="color:#f92672">=</span> cArr[i]
        <span style="color:#66d9ef">return</span> arr[:newLength]
    <span style="color:#66d9ef">finally</span>:
        free(cArr)
</code></pre></td></tr></table>
</div>
</div><p>The <em>cCallBack</em> is a callback function provided to the filter function. <em>cCallBack</em> will get the Python callback function from void* parameter and call it to check whether to keep an element in the array. The filter function takes an integer array. The array is equivalent to the pointer in C. Cython can’t automatically transfer a Python list to an array if the array doesn’t have a fixed length. So, we need to malloc an array in the heap, copy the elements to this array, and finally free this array after use.</p>
<p>The setup script and build command are the same as the previous example. Now, try to use this filter function.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">Python <span style="color:#ae81ff">3.6</span><span style="color:#f92672">.</span><span style="color:#ae81ff">9</span> (default, Oct  <span style="color:#ae81ff">8</span> <span style="color:#ae81ff">2020</span>, <span style="color:#ae81ff">12</span>:<span style="color:#ae81ff">12</span>:<span style="color:#ae81ff">24</span>)
[GCC <span style="color:#ae81ff">8.4</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span>] on linux
Type <span style="color:#e6db74">&#34;help&#34;</span>, <span style="color:#e6db74">&#34;copyright&#34;</span>, <span style="color:#e6db74">&#34;credits&#34;</span> <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;license&#34;</span> <span style="color:#66d9ef">for</span> more information<span style="color:#f92672">.</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">import</span> pfoolib <span style="color:#f92672">as</span> p
<span style="color:#f92672">&gt;&gt;&gt;</span> p<span style="color:#f92672">.</span>pyFilter([<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">9</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">2</span>], <span style="color:#66d9ef">lambda</span> x: x <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
[<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">2</span>]
</code></pre></td></tr></table>
</div>
</div><h1 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h1>
<p>The examples in this blog only show the basic usages of Cython. But these examples can cover many situations that integrate Python code with C code. In the future, I&rsquo;ll introduce more advanced usages of Cython.</p>
<h1 id="explanation">Explanation<a hidden class="anchor" aria-hidden="true" href="#explanation">#</a></h1>
<ol>
<li>What is position independent code (PIC)? PIC is code that works no matter where in memory it is placed. Because several different programs can all use one instance of your shared library, the library cannot store things at fixed addresses, since the location of that library in memory will vary from program to program.<sup>2</sup></li>
<li>Every shared library in Unix-like system has a ‘so-name’, the so-name need to have a lib prefix and .so suffix by default. So, the so-name of foo library is libfoo.so. When you pass a &lsquo;-lfoo&rsquo; parameter to GCC, the compiler will look up the libfoo.so in the link stage. But some basic C libraries don’t have this constraint.</li>
</ol>
<h1 id="reference">Reference<a hidden class="anchor" aria-hidden="true" href="#reference">#</a></h1>
<ol>
<li><a href="https://cython.readthedocs.io/en/latest/index.html">Cython official document</a></li>
<li><a href="https://www.cprogramming.com/tutorial/shared-libraries-linux-gcc.html#fn:pic">Shared libraries with GCC on Linux</a></li>
<li><a href="https://makefiletutorial.com/">Makefile tutorial</a></li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://dennisxie.github.io/tags/python/">python</a></li>
    </ul>
  </footer>
<div id="disqus_thread"></div>
<script>
    

    var disqus_config = function () {
    this.page.url = "https://dennisxie.github.io/post/tech/python/python_bindings_with_cython/";  
    this.page.identifier = "7fa8acd353713dd9afc254459d49a009211f7063"; 
    };
    (function() { 
    var d = document, s = d.createElement('script');
    s.src = 'https://dennisxie-pages.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://dennisxie.github.io/">Dennis&#39;s Grocery</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
